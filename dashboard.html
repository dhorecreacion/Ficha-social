    <!DOCTYPE html>
    <html lang="es">
    <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Dashboard — Bienestar Social</title>

    <!-- Perf: precalienta conexiones a Firebase -->
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firebaseinstallations.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>

    <!-- Estilos globales -->
    <link rel="stylesheet" href="css/app.css"/>
    <link rel="stylesheet" href="css/dashboard.css"/>

    <!-- Estilos locales mínimos (solo responsive/estructura) -->
    <style>
        /* KPIs */
        .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
        .kpi{background:#fff;border-radius:12px;box-shadow:0 4px 22px rgba(2,6,23,.06);padding:14px}
        .kpi .label{color:#6b7280;font-size:12px}
        .kpi .value{font-weight:800;font-size:22px;margin-top:6px}

        /* Secciones y toolbar */
        .section{background:#fff;border-radius:12px;box-shadow:0 4px 22px rgba(2,6,23,.06);padding:16px;margin-bottom:14px}
        .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 12px;flex-wrap:wrap}
        .toolbar .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .toolbar select, .toolbar input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

        /* Grillas de charts */
        .grid-1{display:grid;grid-template-columns:1fr;gap:12px}
        .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
        .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}

        /* Lienzos responsivos: alto relativo al ancho del contenedor */
        canvas{width:100%;height:38vh;max-height:360px;min-height:240px}

        @media (max-width:1100px){
        .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
        .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}
        }
        @media (max-width:820px){
        .grid-2,.grid-3{grid-template-columns:1fr}
        canvas{height:34vh;max-height:320px}
        }
        @media (max-width:560px){
        .kpis{grid-template-columns:1fr}
        canvas{height:30vh;max-height:300px}
        }

        /* Tabla de hijos */
        .table{width:100%;border-collapse:collapse}
        .table th,.table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--line)}
        .table th{font-size:12px;color:#6b7280;font-weight:600}
        .table tr:last-child td{border-bottom:0}
        .muted{color:#6b7280}
        .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
        .badge.minor{background:#dcfce7;color:#166534}
        .badge.soon{background:#fff7ed;color:#9a3412}
        .badge.adult{background:#e5e7eb;color:#374151}

        /* Toolbar de hijos */
        .kids-toolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px;gap:10px;flex-wrap:wrap}
        .kids-toolbar .legend{display:flex;gap:8px;align-items:center;color:#6b7280;font-size:12px;flex-wrap:wrap}
        .kids-toolbar .dot{width:4px;height:4px;background:#d1d5db;border-radius:999px;display:inline-block}
        .kids-toolbar .right{display:flex;gap:10px;align-items:center}
        .kids-toolbar select{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
        .kids-toolbar .btn{height:36px;display:inline-flex;align-items:center}
        .badge.b-minor{background:#dcfce7;color:#166534}
        .badge.b-soon{background:#fff7ed;color:#9a3412}
        .badge.b-major{background:#e5e7eb;color:#374151}

        /* Topbar: botón de menú visible en móvil */
        .topbar .btn.link{padding:6px 10px}
        @media (min-width:821px){
        .topbar .btn.link{display:none}
        }
    </style>

    <!-- Guard: requiere sesión -->
    <script type="module">
        import { requireAuth } from "./js/guard.js";
        requireAuth();
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

    <!-- Lógica del dashboard -->
    <script type="module" src="js/dashboard.js" defer></script>
    </head>
    <body>
    <div class="layout">
        <aside class="aside" id="sidebar">
        <h2>Bienestar social</h2>
        <nav class="nav">
            <a href="fichas.html">Fichas</a>
            <a class="active" href="dashboard.html">Dashboard</a>
            <a href="invitaciones.html">Invitaciones</a>
            <a href="#" id="btnLogout">Cerrar sesión</a>
        </nav>
        </aside>

        <main>
        <header class="topbar">
            <button id="btnMenu" class="btn link" aria-label="Abrir menú" title="Menú">☰</button>
            <strong>Dashboard</strong>
            <span style="width:40px"></span>
        </header>

        <div class="content">
            <!-- KPIs -->
            <div class="kpis">
            <div class="kpi">
                <div class="label">Total fichas</div>
                <div id="kpiTotal" class="value">0</div>
            </div>
            <div class="kpi">
                <div class="label">Completas (≥ 80%)</div>
                <div id="kpiComplete" class="value">0</div>
            </div>
            <div class="kpi">
                <div class="label">Borradores</div>
                <div id="kpiDraft" class="value">0</div>
            </div>
            <div class="kpi">
                <div class="label">Completitud promedio</div>
                <div id="kpiAvg" class="value">0%</div>
            </div>
            </div>

            <!-- Filtros -->
            <div class="section">
            <div class="toolbar">
                <div class="filters">
                <label>Sede
                    <select id="fltSede">
                    <option value="">Todas</option>
                    <option>AREQUIPA</option>
                    <option>LIMA</option>
                    <option>MINA</option>
                    </select>
                </label>
                <label>Rango
                    <select id="fltRango">
                    <option value="30">Últimos 30 días</option>
                    <option value="90">Últimos 90 días</option>
                    <option value="365">Último año</option>
                    <option value="all">Todo</option>
                    </select>
                </label>
                <label>Estado
                    <select id="fltActivo">
                    <option value="active" selected>Activas</option>
                    <option value="inactive">Inactivas</option>
                    <option value="all">Todas</option>
                    </select>
                </label>
                </div>
                <div>
                <button id="btnRefrescar" class="btn">Refrescar</button>
                </div>
            </div>
            </div>

            <!-- Gráficos principales -->
            <div class="grid-2">
            <div class="section">
                <h3 style="margin:0 0 10px">Distribución por género</h3>
                <canvas id="chGenero" aria-label="Género"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Fichas por sede</h3>
                <canvas id="chSede" aria-label="Sede"></canvas>
            </div>
            </div>

            <!-- Más cortes: edad, categoría, estado civil -->
            <div class="grid-3" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Por grupo de edad (adultos)</h3>
                <canvas id="chEdad" aria-label="Edad adultos"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Por categoría</h3>
                <canvas id="chCategoria" aria-label="Categoría"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Por estado civil</h3>
                <canvas id="chEstadoCivil" aria-label="Estado civil"></canvas>
            </div>
            </div>

            <!-- Área y provincia -->
            <div class="grid-2" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Por área</h3>
                <canvas id="chArea" aria-label="Área"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Provincia de residencia (top 15)</h3>
                <canvas id="chProvincia" aria-label="Provincia"></canvas>
            </div>
            </div>

            <!-- Alergias -->
            <div class="grid-1" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Alergias (top 15)</h3>
                <canvas id="chAlergias" aria-label="Alergias"></canvas>
            </div>
            </div>

            <!-- Hijos: total y distribución -->
            <div class="grid-2" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Total de hijos (suma)</h3>
                <canvas id="chHijosTotal" aria-label="Total hijos"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Hijos por sede</h3>
                <canvas id="chHijosPorSede" aria-label="Hijos por sede"></canvas>
            </div>
            </div>

            <div class="grid-2" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Hijos por rango de edad</h3>
                <canvas id="chHijosEdad" aria-label="Hijos por edad"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Distribución de # de hijos por ficha</h3>
                <canvas id="chHijosDist" aria-label="Distribución hijos por ficha"></canvas>
            </div>
            </div>

            <!-- Completitud e históricos -->
            <div class="grid-2" style="margin-top:12px">
            <div class="section">
                <h3 style="margin:0 0 10px">Completitud (0–100%)</h3>
                <canvas id="chCompleto" aria-label="Completitud"></canvas>
            </div>
            <div class="section">
                <h3 style="margin:0 0 10px">Fichas creadas por semana (12)</h3>
                <canvas id="chTiempo" aria-label="Fichas por semana"></canvas>
            </div>
            </div>

            <!-- Lista de hijos -->
            <div class="section" id="kidsSection" style="margin-top:12px">
            <h3 style="margin:0 0 10px">Hijos — menores, próximos a cumplir 18 y mayores</h3>

            <div class="kids-toolbar">
                <div class="legend">
                Semáforo:
                <span class="badge b-minor">Menor</span>
                <span class="dot"></span>
                <span class="badge b-soon">Próximo 18</span>
                <span class="dot"></span>
                <span class="badge b-major">Mayor</span>
                </div>

                <div class="right">
                <label>Ver
                    <select id="kidsFilter">
                    <option value="all">Todos</option>
                    <option value="minor">Solo menores</option>
                    <option value="soon">Próximos 18</option>
                    <option value="major">Mayores</option>
                    </select>
                </label>
                <button id="btnExportKids" class="btn primary">Exportar CSV</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table" id="kidsTable" aria-label="Hijos">
                <thead>
                    <tr>
                    <th style="width:34%">Nombre del hijo(a)</th>
                    <th style="width:26%">Titular (padre/madre)</th>
                    <th style="width:16%">Nacimiento</th>
                    <th style="width:10%">Edad</th>
                    <th style="width:14%">Estado</th>
                    </tr>
                </thead>
                <tbody id="kidsTbody">
                    <tr><td colspan="5" class="muted">Cargando…</td></tr>
                </tbody>
                </table>
            </div>
            </div>

            <p id="msg" class="msg"></p>
        </div>
        </main>
    </div>

    <noscript>Activa JavaScript para ver el dashboard.</noscript>

    <!-- Toggle del sidebar en móvil -->
    <script>
        const btnMenu  = document.getElementById('btnMenu');
        const sidebar  = document.getElementById('sidebar');
        btnMenu?.addEventListener('click', ()=> sidebar?.classList.toggle('open'));
        document.querySelectorAll('.aside .nav a').forEach(a=>{
        a.addEventListener('click', ()=> sidebar?.classList.remove('open'));
        });
    </script>
    </body>
    </html>
